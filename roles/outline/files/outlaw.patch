From 4e47995b4fbdb352f7349092c47c49791681deee Mon Sep 17 00:00:00 2001
From: Yohann Leon <yohann@leon.re>
Date: Fri, 10 Sep 2021 18:51:12 +0200
Subject: [PATCH] fix: apply outlaw patch

---
 app/scenes/Login/Notices.js            |  5 +++++
 server/errors.js                       |  6 ++++++
 server/routes/auth/providers/google.js | 14 ++++++--------
 3 files changed, 17 insertions(+), 8 deletions(-)

diff --git a/app/scenes/Login/Notices.js b/app/scenes/Login/Notices.js
index 34c91073..6538d11c 100644
--- a/app/scenes/Login/Notices.js
+++ b/app/scenes/Login/Notices.js
@@ -33,6 +33,11 @@ export default function Notices() {
           We could not read the user info supplied by your identity provider.
         </NoticeAlert>
       )}
+      {notice === "denied" && (
+        <NoticeAlert>
+          You shall not pass !
+        </NoticeAlert>
+      )}
       {notice === "email-auth-required" && (
         <NoticeAlert>
           Your account uses email sign-in, please sign-in with email to
diff --git a/server/errors.js b/server/errors.js
index ba28608e..1ef770ee 100644
--- a/server/errors.js
+++ b/server/errors.js
@@ -100,6 +100,12 @@ export function GoogleWorkspaceInvalidError(
   return httpErrors(400, message, { id: "hd_not_allowed" });
 }
 
+export function GoogleDenied(
+  message: string = "You shall not pass !"
+) {
+  return httpErrors(400, message, { id: "denied" });
+}
+
 export function OIDCMalformedUserInfoError(
   message: string = "User profile information malformed"
 ) {
diff --git a/server/routes/auth/providers/google.js b/server/routes/auth/providers/google.js
index 885c19c7..dccee04e 100644
--- a/server/routes/auth/providers/google.js
+++ b/server/routes/auth/providers/google.js
@@ -8,6 +8,7 @@ import env from "../../../env";
 import {
   GoogleWorkspaceRequiredError,
   GoogleWorkspaceInvalidError,
+  GoogleDenied,
 } from "../../../errors";
 import passportMiddleware from "../../../middlewares/passport";
 import { getAllowedDomains } from "../../../utils/authentication";
@@ -17,7 +18,6 @@ const router = new Router();
 const providerName = "google";
 const GOOGLE_CLIENT_ID = process.env.GOOGLE_CLIENT_ID;
 const GOOGLE_CLIENT_SECRET = process.env.GOOGLE_CLIENT_SECRET;
-const allowedDomains = getAllowedDomains();
 
 const scopes = [
   "https://www.googleapis.com/auth/userinfo.profile",
@@ -42,16 +42,14 @@ if (GOOGLE_CLIENT_ID) {
       },
       async function (req, accessToken, refreshToken, profile, done) {
         try {
-          const domain = profile._json.hd;
+	  const allowedEmailsEnv = process.env.GOOGLE_ALLOWED_EMAILS;
+	  const allowedEmails = allowedEmailsEnv && allowedEmailsEnv.split(',');
 
-          if (!domain) {
-            throw new GoogleWorkspaceRequiredError();
-          }
-
-          if (allowedDomains.length && !allowedDomains.includes(domain)) {
-            throw new GoogleWorkspaceInvalidError();
+          if (allowedEmails && !allowedEmails.includes(profile.email)) {
+	    throw new GoogleDenied();
           }
 
+	  const domain = process.env.GOOGLE_DOMAIN;
           const subdomain = domain.split(".")[0];
           const teamName = capitalize(subdomain);
 
-- 
2.20.1

